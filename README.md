# Фабрика ботов на Django
### Фабрика асинхронных Телеграм ботов, которые регистрируются через Django админку и располагаются на одном вебхуке.
Все зарегистрированные боты имеют общие хендлеры.
Данный пример хендлеров представлен как чат, интегрированный с OpenAI,
с возможностью отправлять как текстовые сообщения, так и голосовые.
Боты имеют общую базу данных (PostgreSQL) и общаются с ней через ORM SQLAlchemy.

Чтобы иметь возможность обращаться в БД и через SQLAlchemy, и через Django ORM,
модели были продублированы.
- SQLAlchemy: bots/db/models.py
- Django ORM: bots_admin/models.py

В проект также добавлен Celery для возможности отправки сообщений от ботов пользователям по расписанию.
В tasks.py реализована периодическая задача, запускающаяся каждые 5 минут
с проверкой всех существующих чатов на наличие последних сообщений,
которые старше 23 часов. В полученные чаты отправляется приветственное сообщение.

## Наполнение env-файла:

- DEBUG (1 - вкл, 0 - выкл);
- SECRET_KEY (секретный ключ Django);
- ALLOWED_HOSTS (список доступных хостов через запятую без пробела);
- CSRF_TRUSTED_ORIGINS (список доверенных доменов через запятую без пробела)
- POSTGRES_USER (пользователь БД);
- POSTGRES_DB (название БД);
- POSTGRES_PASSWORD (пароль БД);
- POSTGRES_HOST (хост БД)
- TG_BOT_TOKEN (можно указать токен тестового бота для запуска в поллинге)
- REDIS_LOCATION (адрес redis контейнера)
- CELERY_BROKER_URL (адрес redis контейнера или любой другой брокер)
- WEBHOOK_HOST (домен сервера с вебхуком)
- WEBAPP_PORT (порт приложения с вебхуком)

Файл .env должен находиться в корне проекта.

Без env-файла проект не запустится.

## Запуск проекта:
```
sudo docker-compose up -d --build
```
Django-приложение и вебхук для ботов находятся в разных контейнерах с разными зависимостями.
Контейнер bots поднимает и держит сервер для вебхуков, а через контейнер web адреса вебхуков отправляются в Телеграм
для каждого зарегистрированного в админке бота.
При удалении экземпляра бота, вебхук удаляется из Телеграма.

Миграции и сборка статики для Django запускаются сами в скрипте start_server.sh.
### Админка проекта будет доступна по ссылке:
```
http://localhost/admin/
```
## Создание суперпользователя
В контейнере web запустить команду:
```
python manage.py createsuperuser
```
